<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="https://resource.tinychen.com/logos.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://resource.tinychen.com/logos.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://resource.tinychen.com/logos.png">
  <link rel="mask-icon" href="https://resource.tinychen.com/logos.png" color="#222">
  <link rel="alternate" href="/atom.xml" title="TinyChen's Studio" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-material.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://tinychen.com').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="本文主要对coredns的原理和特性进行介绍，同时会对其二进制的安装方法进行尝试。">
<meta property="og:type" content="article">
<meta property="og:title" content="DNS系列03-coredns简介和安装">
<meta property="og:url" content="https://tinychen.com/20210509-dns03-coredns-introduction/index.html">
<meta property="og:site_name" content="TinyChen&#39;s Studio">
<meta property="og:description" content="本文主要对coredns的原理和特性进行介绍，同时会对其二进制的安装方法进行尝试。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://resource.tinychen.com/20210508151516.png">
<meta property="og:image" content="https://resource.tinychen.com/20210511112440.png">
<meta property="og:image" content="https://resource.tinychen.com/20210511145618.png">
<meta property="article:published_time" content="2021-05-09T03:00:00.000Z">
<meta property="article:modified_time" content="2021-05-09T03:00:00.000Z">
<meta property="article:author" content="TinyChen">
<meta property="article:tag" content="network">
<meta property="article:tag" content="dns">
<meta property="article:tag" content="coredns">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://resource.tinychen.com/20210508151516.png">

<link rel="canonical" href="https://tinychen.com/20210509-dns03-coredns-introduction/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>DNS系列03-coredns简介和安装 | TinyChen's Studio</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-166769908-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-166769908-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?7a96963a1145ac7fde1442d739a11ffd";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">TinyChen's Studio</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">DO or DIE</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://tinychen.com/20210509-dns03-coredns-introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://resource.tinychen.com/logo.jpg">
      <meta itemprop="name" content="TinyChen">
      <meta itemprop="description" content=" ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TinyChen's Studio">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          DNS系列03-coredns简介和安装
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-05-09 11:00:00" itemprop="dateCreated datePublished" datetime="2021-05-09T11:00:00+08:00">2021-05-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="https://resource.tinychen.com/20210508151516.png"></p>
<p>本文主要对coredns的原理和特性进行介绍，同时会对其二进制的安装方法进行尝试。</p>
<a id="more"></a>

<h1 id="1、coredns简介"><a href="#1、coredns简介" class="headerlink" title="1、coredns简介"></a>1、coredns简介</h1><p>coredns是一个用go语言编写的开源的DNS服务，它的官网可以点击<a target="_blank" rel="noopener" href="https://coredns.io/">这里</a>，github页面可以点击<a target="_blank" rel="noopener" href="https://github.com/coredns/coredns">这里</a>。需要额外注意的是，coredns是首批加入<a target="_blank" rel="noopener" href="https://www.cncf.io/">CNCF</a>组织的云原生开源项目，并且作为已经在CNCF毕业的项目，coredns还是目前kubernetes中默认的dns服务。同时，由于coredns可以集成插件，它还能够实现服务发现的功能。</p>
<p>coredns和其他的诸如bind、knot、powerdns、unbound等DNS服务不同的是：coredns非常的灵活，并且几乎把所有的核心功能实现都外包给了插件。比如说如果你想要在coredns中加入Prometheus的监控支持，那么只需要安装对应的prometheus插件并且启用即可，因此官方也说coredns是由插件驱动的。</p>
<blockquote>
<p><em>CoreDNS is powered by plugins.</em></p>
</blockquote>
<p>对于coredns插件的定义，官网是这样表示的：<strong>插件是能够单独或者共同实现一个“DNS的功能（DNS function）”</strong>。</p>
<blockquote>
<p>Plugins can be stand-alone or work together to perform a “DNS function”.</p>
<p>So what’s a “DNS function”? For the purpose of CoreDNS, we define it as a piece of software that implements the CoreDNS Plugin API. The functionality implemented can wildly deviate. There are plugins that don’t themselves create a response, such as <a target="_blank" rel="noopener" href="https://coredns.io/plugins/metrics">metrics</a> or <a target="_blank" rel="noopener" href="https://coredns.io/plugins/cache">cache</a>, but that add functionality. Then there are plugins that <em>do</em> generate a response. These can also do anything: There are plugins that communicate with <a target="_blank" rel="noopener" href="https://coredns.io/plugins/kubernetes">Kubernetes</a> to provide service discovery, plugins that read data from a <a target="_blank" rel="noopener" href="https://coredns.io/plugins/file">file</a> or a <a target="_blank" rel="noopener" href="https://coredns.io/explugins/pdsql">database</a>.</p>
</blockquote>
<h1 id="2、coredns安装"><a href="#2、coredns安装" class="headerlink" title="2、coredns安装"></a>2、coredns安装</h1><p>和大多数的软件一样，<strong>coredns提供了源码编译、预编译包和docker镜像三种安装方式</strong>。这里我们使用预编译包的方式进行安装。coredns在<a target="_blank" rel="noopener" href="https://github.com/coredns/coredns/releases/">github</a>上面提供了各种版本的预编译包，我们只需要下载对应的硬件版本即可。</p>
<p>解压对应的版本后可以得到一个二进制文件，直接执行就可以使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@tiny-server coredns]# .&#x2F;coredns --help</span><br><span class="line">Usage of .&#x2F;coredns:</span><br><span class="line">  -conf string</span><br><span class="line">        Corefile to load (default &quot;Corefile&quot;)</span><br><span class="line">  -dns.port string</span><br><span class="line">        Default port (default &quot;53&quot;)</span><br><span class="line">  -pidfile string</span><br><span class="line">        Path to write pid file</span><br><span class="line">  -plugins</span><br><span class="line">        List installed plugins</span><br><span class="line">  -quiet</span><br><span class="line">        Quiet mode (no initialization output)</span><br><span class="line">  -version</span><br><span class="line">        Show version</span><br></pre></td></tr></table></figure>

<p>需要注意的是，对于预编译的版本，会内置全部官方认证的插件，也就是官网的<a target="_blank" rel="noopener" href="https://coredns.io/plugins/">插件页面</a>列出来的全部插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@tiny-server coredns]# .&#x2F;coredns -plugins</span><br><span class="line">Server types:</span><br><span class="line">  dns</span><br><span class="line"></span><br><span class="line">Caddyfile loaders:</span><br><span class="line">  flag</span><br><span class="line">  default</span><br><span class="line"></span><br><span class="line">Other plugins:</span><br><span class="line">  dns.acl</span><br><span class="line">  dns.any</span><br><span class="line">  dns.auto</span><br><span class="line">  dns.autopath</span><br><span class="line">  dns.azure</span><br><span class="line">  dns.bind</span><br><span class="line">  dns.bufsize</span><br><span class="line">  dns.cache</span><br><span class="line">  dns.cancel</span><br><span class="line">  dns.chaos</span><br><span class="line">  dns.clouddns</span><br><span class="line">  dns.debug</span><br><span class="line">  dns.dns64</span><br><span class="line">  dns.dnssec</span><br><span class="line">  dns.dnstap</span><br><span class="line">  dns.erratic</span><br><span class="line">  dns.errors</span><br><span class="line">  dns.etcd</span><br><span class="line">  dns.file</span><br><span class="line">  dns.forward</span><br><span class="line">  dns.grpc</span><br><span class="line">  dns.health</span><br><span class="line">  dns.hosts</span><br><span class="line">  dns.k8s_external</span><br><span class="line">  dns.kubernetes</span><br><span class="line">  dns.loadbalance</span><br><span class="line">  dns.local</span><br><span class="line">  dns.log</span><br><span class="line">  dns.loop</span><br><span class="line">  dns.metadata</span><br><span class="line">  dns.nsid</span><br><span class="line">  dns.pprof</span><br><span class="line">  dns.prometheus</span><br><span class="line">  dns.ready</span><br><span class="line">  dns.reload</span><br><span class="line">  dns.rewrite</span><br><span class="line">  dns.root</span><br><span class="line">  dns.route53</span><br><span class="line">  dns.secondary</span><br><span class="line">  dns.sign</span><br><span class="line">  dns.template</span><br><span class="line">  dns.tls</span><br><span class="line">  dns.trace</span><br><span class="line">  dns.transfer</span><br><span class="line">  dns.whoami</span><br><span class="line">  on</span><br></pre></td></tr></table></figure>

<p>coredns的运行也非常简单，直接运行二进制文件即可，默认情况下可以添加的参数不多，主要是指定配置文件，指定运行端口和设置quiet模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@tiny-server coredns]# .&#x2F;coredns</span><br><span class="line">.:53</span><br><span class="line">CoreDNS-1.8.3</span><br><span class="line">linux&#x2F;amd64, go1.16, 4293992</span><br></pre></td></tr></table></figure>

<p>默认情况下会直接监听53端口，并且读取和自己在相同目录下的Corefile配置文件。但是在这种情况下，虽然coredns正常运行了，但是由于没有配置文件，是无法正常解析任何域名请求的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 直接运行coredns让其监听30053端口</span></span><br><span class="line">[root@tiny-server coredns-test]# ./coredns -dns.port 30053</span><br><span class="line">.:30053</span><br><span class="line">CoreDNS-1.8.3</span><br><span class="line">linux/amd64, go1.16, 4293992</span><br><span class="line">[INFO] 127.0.0.1:47910 - 63992 "A IN tinychen.com. udp 53 false 4096" NOERROR qr,aa,rd 94 0.000162476s</span><br><span class="line">[INFO] 127.0.0.1:48764 - 26598 "A IN tinychen.com. udp 53 false 4096" NOERROR qr,aa,rd 94 0.000135895s</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用dig命令进行测试，发现能够正常返回请求但是解析的结果不正确</span></span><br><span class="line">[root@tiny-server coredns-test]# dig tinychen.com @127.0.0.1 -p30053</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.20-RedHat-9.11.20-5.el8_3.1 &lt;&lt;&gt;&gt; tinychen.com @127.0.0.1 -p30053</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 26598</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 3</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">; COOKIE: 4429aa454c031afe (echoed)</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;tinychen.com.                  IN      A</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">tinychen.com.           0       IN      A       127.0.0.1</span><br><span class="line">_udp.tinychen.com.      0       IN      SRV     0 0 48764 .</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#30053(127.0.0.1)</span><br><span class="line">;; WHEN: Tue May 11 11:39:47 CST 2021</span><br><span class="line">;; MSG SIZE  rcvd: 117</span><br></pre></td></tr></table></figure>

<p>这里我们简单编写一个Corefile配置文件就能够先让coredns正常解析域名，这个配置文件的意识是对所有域的请求都forward到114DNS进行解析，并且记录正常的日志和错误的日志。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@tiny-server coredns]# cat Corefile</span><br><span class="line">. &#123;</span><br><span class="line">    forward . 114.114.114.114 223.5.5.5</span><br><span class="line">    log</span><br><span class="line">    errors</span><br><span class="line">    whoami</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们再进行测试就发现coredns可以正常解析域名了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@tiny-server coredns-test]# dig tinychen.com @127.0.0.1 -p30053</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.20-RedHat-9.11.20-5.el8_3.1 &lt;&lt;&gt;&gt; tinychen.com @127.0.0.1 -p30053</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 49732</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;tinychen.com.                  IN      A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">tinychen.com.           35      IN      A       47.107.188.168</span><br><span class="line"></span><br><span class="line">;; Query time: 29 msec</span><br><span class="line">;; SERVER: 127.0.0.1#30053(127.0.0.1)</span><br><span class="line">;; WHEN: Tue May 11 14:02:41 CST 2021</span><br><span class="line">;; MSG SIZE  rcvd: 69</span><br><span class="line"></span><br><span class="line">[root@tiny-server coredns-test]# ./coredns -dns.port 30053</span><br><span class="line">.:30053</span><br><span class="line">CoreDNS-1.8.3</span><br><span class="line">linux/amd64, go1.16, 4293992</span><br><span class="line">[INFO] 127.0.0.1:42293 - 51799 "A IN tinychen.com. udp 53 false 4096" NOERROR qr,rd,ra 58 0.244014828s</span><br></pre></td></tr></table></figure>

<h1 id="3、systemd管理"><a href="#3、systemd管理" class="headerlink" title="3、systemd管理"></a>3、systemd管理</h1><p>coredns作为一个二进制执行文件，并没有向其他的如nginx、bind等服务提供种类繁多的进程控制（reload stop restart等等）选项，因此为了方便我们管理和在后台一直运行coredns，这里我们使用systemd对其进行管理，只需要编写一个systemd的unit文件即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@tiny-server coredns]# cat /usr/lib/systemd/system/coredns.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=CoreDNS</span><br><span class="line">Documentation=https://coredns.io/manual/toc/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Type设置为notify时，服务会不断重启</span></span><br><span class="line">Type=simple</span><br><span class="line">User=root</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定运行端口和读取的配置文件</span></span><br><span class="line">ExecStart=/home/coredns/coredns -dns.port=53 -conf /home/coredns/Corefile</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>编写完成之后我们依次reload配置文件并且设置开机启动服务和开启服务，即可看到服务正常运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@tiny-server coredns]# systemctl daemon-reload</span><br><span class="line">[root@tiny-server coredns]# systemctl enable coredns.service</span><br><span class="line">[root@tiny-server coredns]# systemctl start coredns.service</span><br><span class="line">[root@tiny-server coredns]# systemctl status coredns.service</span><br><span class="line">● coredns.service - CoreDNS</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/coredns.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Tue 2021-05-11 11:29:53 CST; 2h 37min ago</span><br><span class="line">     Docs: https://coredns.io/manual/toc/</span><br><span class="line"> Main PID: 131287 (coredns)</span><br><span class="line">    Tasks: 10 (limit: 49835)</span><br><span class="line">   Memory: 27.3M</span><br><span class="line">   CGroup: /system.slice/coredns.service</span><br><span class="line">           └─131287 /home/coredns/coredns -dns.port=53 -conf /home/coredns/Corefile</span><br><span class="line"></span><br><span class="line">May 11 11:29:53 tiny-server systemd[1]: Started CoreDNS.</span><br></pre></td></tr></table></figure>

<h1 id="4、coredns日志处理"><a href="#4、coredns日志处理" class="headerlink" title="4、coredns日志处理"></a>4、coredns日志处理</h1><p>coredns的日志输出并不如nginx那么完善（并不能在配置文件中指定输出的文件目录，但是可以指定日志的格式），默认情况下不论是log插件还是error插件都会把所有的相关日志输出到程序的<code>standard output</code>中，使用systemd来管理coredns之后，</p>
<h2 id="4-1-StandardOutput"><a href="#4-1-StandardOutput" class="headerlink" title="4.1 StandardOutput"></a>4.1 StandardOutput</h2><p>根据网上的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/37585758/how-to-redirect-output-of-systemd-service-to-a-file">参考资料</a>我们可以得知较新版本的systemd是可以直接在systemd的unit文件里面配置<code>StandardOutput</code>和<code>StandardError</code>两个参数来将相关运行日志输出到指定的文件中。</p>
<p><img src="https://resource.tinychen.com/20210511112440.png"></p>
<p>因此对于centos8等较新的系统，我们的unit文件可以这样编写：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=CoreDNS</span><br><span class="line">Documentation=https://coredns.io/manual/toc/</span><br><span class="line">After=network.target</span><br><span class="line"><span class="meta">#</span><span class="bash"> StartLimit这两个相关参数也是centos8等systemd版本较新的系统才支持的</span></span><br><span class="line">StartLimitBurst=1</span><br><span class="line">StartLimitIntervalSec=15s</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Type设置为notify时，服务会不断重启</span></span><br><span class="line">Type=simple</span><br><span class="line">User=root</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定运行端口和读取的配置文件</span></span><br><span class="line">ExecStart=/home/coredns/coredns -dns.port=53 -conf /home/coredns/Corefile</span><br><span class="line"><span class="meta">#</span><span class="bash"> append类型可以在原有文件末尾继续追加内容，而file类型则是重新打开一个新文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 两者的区别类似于 <span class="built_in">echo</span> &gt;&gt; 和 <span class="built_in">echo</span> &gt;</span></span><br><span class="line">StandardOutput=append:/home/coredns/logs/coredns.log</span><br><span class="line">StandardError=append:/home/coredns/logs/coredns_error.log</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考链接：<a target="_blank" rel="noopener" href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#StandardOutput=">systemd.exec (www.freedesktop.org)</a></p>
<p>The <code>file:*</code>path<code>*</code> option may be used to connect a specific file system object to standard output. The semantics are similar to the same option of <code>StandardInput=</code>, see above. If <em><code>path</code></em> refers to a regular file on the filesystem, it is opened (created if it doesn’t exist yet) for writing at the beginning of the file, but without truncating it. If standard input and output are directed to the same file path, it is opened only once, for reading as well as writing and duplicated. This is particularly useful when the specified path refers to an <code>AF_UNIX</code> socket in the file system, as in that case only a single stream connection is created for both input and output.</p>
<p><code>append:*</code>path<code>*</code> is similar to <code>file:*</code>path<code>*</code> above, but it opens the file in append mode.</p>
</blockquote>
<p>修改完成之后我们再重启服务就可以看到日志已经被重定向输出到我们指定的文件中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@tiny-server coredns]# systemctl daemon-reload</span><br><span class="line">[root@tiny-server coredns]# systemctl restart coredns.service</span><br></pre></td></tr></table></figure>

<h2 id="4-2-rsyslog"><a href="#4-2-rsyslog" class="headerlink" title="4.2 rsyslog"></a>4.2 rsyslog</h2><p>对于centos7等系统而言，是不支持上面的append和file两个参数的，那么在开启了<code>rsyslog.service</code>服务的情况下，日志就会输出到<code>/var/log/messages</code>文件中，或者可以使用<code>journalctl -u coredns</code>命令来查看全部的日志。</p>
<p>如果想要将coredns的日志全部集中到一个文件进行统一管理，我们可以对负责管理<code>systemd</code>的日志的<code>rsyslog</code>服务的配置进行修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/rsyslog.conf</span></span><br><span class="line">if $programname == 'coredns' then /home/coredns/logs/coredns.log</span><br><span class="line">&amp; stop</span><br><span class="line"></span><br><span class="line">[root@tiny-server coredns]# systemctl restart rsyslog.service</span><br></pre></td></tr></table></figure>

<p>从下图我们可以看到两种方式打出来的日志稍微有些不同，对于<code>StandardOutput</code>这种方式输出的日志缺少了前面的时间和主机名等信息，相对而言还是修改rsyslog的方式要更加的可靠。</p>
<p><img src="https://resource.tinychen.com/20210511145618.png"></p>

    </div>

    
    
    
      
  <div class="popular-posts-header">Related Posts</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\20200417-dns01-dns-introduction\" rel="bookmark">DNS系列01-DNS原理介绍</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\20210224-dns02-pdns-auth-and-rec-introduction\" rel="bookmark">DNS系列02-PDNS简介</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\20190227-special-ip\" rel="bookmark">计算机中的一些特殊IP地址</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\20190330-base-know-of-cn-1\" rel="bookmark">100条计算机网络基本知识（上）</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\20190404-make-cat6-cable\" rel="bookmark">直通线和交叉线的制作</a></div>
    </li>
  </ul>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/network/" rel="tag"># network</a>
              <a href="/tags/dns/" rel="tag"># dns</a>
              <a href="/tags/coredns/" rel="tag"># coredns</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/20210408-centos8-create-bridge/" rel="prev" title="在centos8中使用nmcli工具创建虚拟网桥">
      <i class="fa fa-chevron-left"></i> 在centos8中使用nmcli工具创建虚拟网桥
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1%E3%80%81coredns%E7%AE%80%E4%BB%8B"><span class="nav-text">1、coredns简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2%E3%80%81coredns%E5%AE%89%E8%A3%85"><span class="nav-text">2、coredns安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3%E3%80%81systemd%E7%AE%A1%E7%90%86"><span class="nav-text">3、systemd管理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4%E3%80%81coredns%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86"><span class="nav-text">4、coredns日志处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-StandardOutput"><span class="nav-text">4.1 StandardOutput</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-rsyslog"><span class="nav-text">4.2 rsyslog</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="TinyChen"
      src="https://resource.tinychen.com/logo.jpg">
  <p class="site-author-name" itemprop="name">TinyChen</p>
  <div class="site-description" itemprop="description"> </div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">157</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/tiny777" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tiny777" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:tinyseventh@gmail.com" title="Gmail → mailto:tinyseventh@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-google"></i>Gmail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/tinyseventh/posts" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;tinyseventh&#x2F;posts" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>知乎</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/c3de3c0ad794" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;c3de3c0ad794" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>简书</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_36885515" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_36885515" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>CSDN</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备18140640号 </a>
  </div>

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">TinyChen</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">703k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">10:39</span>
</div>

        








        
      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>














  

  

</body>
</html>
